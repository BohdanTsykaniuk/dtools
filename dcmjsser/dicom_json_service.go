package main

import "io/ioutil"
import "net/http"
import "strconv"
import "log"
import "encoding/json"
import "errors"

//import "encoding/base64"

const htmlData = "DQo8IWRvY3R5cGUgaHRtbD4NCg0KPGh0bWw+DQogIA0KICA8aGVhZD4NCiAgICA8dGl0bGU+SnVzdGlmaWVkIE5hdjwvdGl0bGU+DQogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCI+DQogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3Rzd2F0Y2gvMy4wLjAvc2xhdGUvYm9vdHN0cmFwLm1pbi5jc3MiPg0KICAgIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vYWpheC5nb29nbGVhcGlzLmNvbS9hamF4L2xpYnMvanF1ZXJ5LzIuMC4zL2pxdWVyeS5taW4uanMiPjwvc2NyaXB0Pg0KICAgIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9Imh0dHBzOi8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMS4xL2pzL2Jvb3RzdHJhcC5taW4uanMiPjwvc2NyaXB0Pg0KICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+DQogICAgICBib2R5IHsNCiAgICAgICAgcGFkZGluZy10b3A6IDIwcHg7DQogICAgICB9DQogICAgICAuZm9vdGVyIHsNCiAgICAgICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkICNlZWU7DQogICAgICAgIG1hcmdpbi10b3A6IDQwcHg7DQogICAgICAgIHBhZGRpbmctdG9wOiA0MHB4Ow0KICAgICAgICBwYWRkaW5nLWJvdHRvbTogNDBweDsNCiAgICAgIH0NCiAgICAgIC8qIE1haW4gbWFya2V0aW5nIG1lc3NhZ2UgYW5kIHNpZ24gdXAgYnV0dG9uICovDQogICAgICAuanVtYm90cm9uIHsNCiAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOw0KICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsNCiAgICAgIH0NCiAgICAgIC5qdW1ib3Ryb24gLmJ0biB7DQogICAgICAgIGZvbnQtc2l6ZTogMjFweDsNCiAgICAgICAgcGFkZGluZzogMTRweCAyNHB4Ow0KICAgICAgfQ0KICAgICAgLyogQ3VzdG9taXplIHRoZSBuYXYtanVzdGlmaWVkIGxpbmtzIHRvIGJlIGZpbGwgdGhlIGVudGlyZSBzcGFjZSBvZiB0aGUgLm5hdmJhciAqLw0KICAgICAgLm5hdi1qdXN0aWZpZWQgew0KICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZWVlOw0KICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7DQogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNjY2M7DQogICAgICB9DQogICAgICAubmF2LWp1c3RpZmllZCA+IGxpID4gYSB7DQogICAgICAgIHBhZGRpbmctdG9wOiAxNXB4Ow0KICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTVweDsNCiAgICAgICAgY29sb3I6ICM3Nzc7DQogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOw0KICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZDVkNWQ1Ow0KICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZTVlNWU1Ow0KICAgICAgICAvKiBPbGQgYnJvd3NlcnMgKi8NCiAgICAgICAgYmFja2dyb3VuZC1yZXBlYXQ6IHJlcGVhdC14Ow0KICAgICAgICAvKiBSZXBlYXQgdGhlIGdyYWRpZW50ICovDQogICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IC1tb3otbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgLyogRkYzLjYrICovDQogICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IC13ZWJraXQtZ3JhZGllbnQobGluZWFyLCBsZWZ0IHRvcCwgbGVmdCBib3R0b20sIGNvbG9yLXN0b3AoMCUsICNmNWY1ZjUpLCBjb2xvci1zdG9wKDEwMCUsICNlNWU1ZTUpKTsNCiAgICAgICAgLyogQ2hyb21lLFNhZmFyaTQrICovDQogICAgICAgIGJhY2tncm91bmQtaW1hZ2U6IC13ZWJraXQtbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgLyogQ2hyb21lIDEwKyxTYWZhcmkgNS4xKyAqLw0KICAgICAgICBiYWNrZ3JvdW5kLWltYWdlOiAtbXMtbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgLyogSUUxMCsgKi8NCiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogLW8tbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgLyogT3BlcmEgMTEuMTArICovDQogICAgICAgIGZpbHRlcjogcHJvZ2lkOkRYSW1hZ2VUcmFuc2Zvcm0uTWljcm9zb2Z0LmdyYWRpZW50KHN0YXJ0Q29sb3JzdHI9JyNmNWY1ZjUnLCBlbmRDb2xvcnN0cj0nI2U1ZTVlNScsIEdyYWRpZW50VHlwZT0wKTsNCiAgICAgICAgLyogSUU2LTkgKi8NCiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRvcCwgI2Y1ZjVmNSAwJSwgI2U1ZTVlNSAxMDAlKTsNCiAgICAgICAgLyogVzNDICovDQogICAgICB9DQogICAgICAubmF2LWp1c3RpZmllZCA+IC5hY3RpdmUgPiBhLCAubmF2LWp1c3RpZmllZCA+IC5hY3RpdmUgPiBhOmhvdmVyLCAubmF2LWp1c3RpZmllZCA+IC5hY3RpdmUgPiBhOmZvY3VzIHsNCiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2RkZDsNCiAgICAgICAgYmFja2dyb3VuZC1pbWFnZTogbm9uZTsNCiAgICAgICAgYm94LXNoYWRvdzogaW5zZXQgMCAzcHggN3B4IHJnYmEoMCwgMCwgMCwgLjE1KTsNCiAgICAgIH0NCiAgICAgIC5uYXYtanVzdGlmaWVkID4gbGk6Zmlyc3QtY2hpbGQgPiBhIHsNCiAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4IDVweCAwIDA7DQogICAgICB9DQogICAgICAubmF2LWp1c3RpZmllZCA+IGxpOmxhc3QtY2hpbGQgPiBhIHsNCiAgICAgICAgYm9yZGVyLWJvdHRvbTogMDsNCiAgICAgICAgYm9yZGVyLXJhZGl1czogMCAwIDVweCA1cHg7DQogICAgICB9DQogICAgICBAbWVkaWEobWluLXdpZHRoOiA3NjhweCkgew0KICAgICAgICAubmF2LWp1c3RpZmllZCB7DQogICAgICAgICAgbWF4LWhlaWdodDogNTJweDsNCiAgICAgICAgfQ0KICAgICAgICAubmF2LWp1c3RpZmllZCA+IGxpID4gYSB7DQogICAgICAgICAgYm9yZGVyLWxlZnQ6IDFweCBzb2xpZCAjZmZmOw0KICAgICAgICAgIGJvcmRlci1yaWdodDogMXB4IHNvbGlkICNkNWQ1ZDU7DQogICAgICAgIH0NCiAgICAgICAgLm5hdi1qdXN0aWZpZWQgPiBsaTpmaXJzdC1jaGlsZCA+IGEgew0KICAgICAgICAgIGJvcmRlci1sZWZ0OiAwOw0KICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweCAwIDAgNXB4Ow0KICAgICAgICB9DQogICAgICAgIC5uYXYtanVzdGlmaWVkID4gbGk6bGFzdC1jaGlsZCA+IGEgew0KICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDAgNXB4IDVweCAwOw0KICAgICAgICAgIGJvcmRlci1yaWdodDogMDsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyogUmVzcG9uc2l2ZTogUG9ydHJhaXQgdGFibGV0cyBhbmQgdXAgKi8NCiAgICAgIEBtZWRpYSBzY3JlZW4gYW5kKG1pbi13aWR0aDogNzY4cHgpIHsNCiAgICAgICAgLyogUmVtb3ZlIHRoZSBwYWRkaW5nIHdlIHNldCBlYXJsaWVyICovDQogICAgICAgIC5tYXN0aGVhZCwgLm1hcmtldGluZywgLmZvb3RlciB7DQogICAgICAgICAgcGFkZGluZy1sZWZ0OiAwOw0KICAgICAgICAgIHBhZGRpbmctcmlnaHQ6IDA7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICA8L3N0eWxlPg0KICA8L2hlYWQ+DQogIA0KICA8Ym9keT4NCiAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPg0KICAgICAgPGRpdiBjbGFzcz0id2VsbCI+DQogICAgICAgIDxkaXYgY2xhc3M9InBhbmVsLWZvb3RlciI+RElDT00gU2VydmVyIHNldHRpbmdzDQogICAgICAgIDwvZGl2Pg0KICAgICAgICA8dGFibGUgY2xhc3M9InRhYmxlIHRhYmxlLWJvcmRlcmVkIHRhYmxlLWNvbmRlbnNlZCB0YWJsZS1ob3ZlciB0YWJsZS1zdHJpcGVkIj4NCiAgICAgICAgICA8dGJvZHk+DQogICAgICAgICAgICA8dHI+DQogICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+RElDT00gc2VydmVyIGFkZHJlc3M8L2xhYmVsPg0KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImZvcm0tY29udHJvbCBpbnB1dC1zbSI+DQogICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgPHRkPg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPg0KICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5BRS1UaXRsZTwvbGFiZWw+DQogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9scyI+DQogICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0iZm9ybS1jb250cm9sIGlucHV0LXNtIj4NCiAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICA8L3RkPg0KICAgICAgICAgICAgICA8dGQ+DQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+DQogICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPlBvcnQgbnVtYmVyPC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iPg0KICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+RElDT00gcGluZyBzdGF0dXM6PC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgIDxwPg0KICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPk9LPC9sYWJlbD48L3A+DQogICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICA8L3RyPg0KICAgICAgICAgIDwvdGJvZHk+DQogICAgICAgIDwvdGFibGU+DQogICAgICAgIDxkaXYgY2xhc3M9InBhbmVsLWZvb3RlciI+U2VhcmNoIFNldHRpbmdzDQogICAgICAgIDwvZGl2Pg0KICAgICAgICA8dGFibGUgY2xhc3M9InRhYmxlIHRhYmxlLWJvcmRlcmVkIHRhYmxlLWNvbmRlbnNlZCB0YWJsZS1ob3ZlciB0YWJsZS1zdHJpcGVkIj4NCiAgICAgICAgICA8dGJvZHk+DQogICAgICAgICAgICA8dHI+DQogICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+UGF0aWVudCBuYW1lPC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iPg0KICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+UGF0aWVudCBNUk48L2xhYmVsPg0KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImZvcm0tY29udHJvbCBpbnB1dC1zbSI+DQogICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgPHRkPg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPg0KICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5TdHVkeSBJRDwvbGFiZWw+DQogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9scyI+DQogICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0iZm9ybS1jb250cm9sIGlucHV0LXNtIj4NCiAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICA8L3RkPg0KICAgICAgICAgICAgICA8dGQ+DQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncm91cCI+DQogICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPkRhdGUgb2YgYmlydGg8L2xhYmVsPg0KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29udHJvbHMiPg0KICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImZvcm0tY29udHJvbCBpbnB1dC1zbSI+DQogICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgPHRkPg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPg0KICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5TdHVkeSBkYXRlPC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGNsYXNzPSJmb3JtLWNvbnRyb2wgaW5wdXQtc20iPg0KICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+RXhlY3V0ZTwvbGFiZWw+IDwvcD4NCiAgICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXNtIj5GIEkgTiBEPC9hPg0KICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICA8L3RkPg0KICAgICAgICAgICAgPC90cj4NCiAgICAgICAgICA8L3Rib2R5Pg0KICAgICAgICA8L3RhYmxlPg0KICAgICAgPC9kaXY+DQogICAgPC9kaXY+DQogIDwvYm9keT4NCg0KPC9odG1sPg=="

type HttpResReq struct {
	ResponseWriter http.ResponseWriter
	Request        *http.Request
}

//main service class
type DicomJsonService struct {
	jobBallancer    JobBallancer
	dicomDispatcher DicomDispatcher
	responses       map[string]HttpResReq
}

//start and init service
func (service *DicomJsonService) Start(listenPort int) error {
	http.HandleFunc("/c-echo", service.cEcho)
	http.HandleFunc("/index.html", service.ServePage)
	if err := http.ListenAndServe(":"+strconv.Itoa(listenPort), nil); err != nil {
		return errors.New("error: can't start listen http server")
	}
	service.jobBallancer.Init(&service.dicomDispatcher, new(OnCompletedResp), new(OnErrorResp))
	service.responses = make(map[string]HttpResReq)
	return nil
}

//serve cEcho responce
func (service *DicomJsonService) cEcho(responseWriter http.ResponseWriter, request *http.Request) {
	defer request.Body.Close()
	bodyData, err := ioutil.ReadAll(request.Body)
	if err != nil {
		strErr := "error: Can't read http body data"
		responseWriter.Write([]byte(strErr))
		log.Println(strErr)
		return
	}
	var dicomCEchoRequest DicomCEchoRequest
	if err := json.Unmarshal(bodyData, &dicomCEchoRequest); err != nil {
		strErr := "error: can't parse DicomCEchoRequest data"
		responseWriter.Write([]byte(strErr))
		log.Println(strErr)
	}

	if guid, err := service.jobBallancer.PushJob(dicomCEchoRequest); err == nil {
		service.responses[guid] = HttpResReq{Request: request, ResponseWriter: responseWriter}
	} else {
		log.Printf("error: can't push job")
	}

}

//serve main page request
func (service *DicomJsonService) ServePage(responseWriter http.ResponseWriter, request *http.Request) {
	responseWriter.Header().Set("Content-Type: text/html", "*")

	content, err := ioutil.ReadFile("index.html") //base64.StdEncoding.DecodeString(htmlData)
	if err != nil {
		responseWriter.Write([]byte("error: Can't find start page \n"))
		return
	}
	responseWriter.Write(content)
}
